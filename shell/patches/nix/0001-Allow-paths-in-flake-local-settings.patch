From 251a3c6a288ffaa8f7ea80d068222e7ba9dc8f80 Mon Sep 17 00:00:00 2001
From: regnat <rg@regnat.ovh>
Date: Fri, 12 Nov 2021 16:28:39 +0100
Subject: [PATCH] Allow paths in flake local settings

Fix #5505
---
 src/libexpr/flake/flake.cc    |  4 ++++
 tests/flake-local-settings.sh | 14 ++++++++++++--
 2 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/src/libexpr/flake/flake.cc b/src/libexpr/flake/flake.cc
index f5be67d6740..77b9b731d8f 100644
--- a/src/libexpr/flake/flake.cc
+++ b/src/libexpr/flake/flake.cc
@@ -251,6 +251,10 @@ static Flake getFlake(
             forceTrivialValue(state, *setting.value, *setting.pos);
             if (setting.value->type() == nString)
                 flake.config.settings.insert({setting.name, state.forceStringNoCtx(*setting.value, *setting.pos)});
+            else if (setting.value->type() == nPath) {
+                PathSet emptyContext = {};
+                flake.config.settings.insert({setting.name, state.coerceToString(*setting.pos, *setting.value, emptyContext, false, true, true)});
+            }
             else if (setting.value->type() == nInt)
                 flake.config.settings.insert({setting.name, state.forceInt(*setting.value, *setting.pos)});
             else if (setting.value->type() == nBool)
diff --git a/tests/flake-local-settings.sh b/tests/flake-local-settings.sh
index 09f6b4ca813..5c7b852545d 100644
--- a/tests/flake-local-settings.sh
+++ b/tests/flake-local-settings.sh
@@ -11,13 +11,13 @@ rm -f post-hook-ran
 cat <<EOF > echoing-post-hook.sh
 #!/bin/sh
 
-echo "ThePostHookRan" > $PWD/post-hook-ran
+echo "ThePostHookRan as \$0" > $PWD/post-hook-ran
 EOF
 chmod +x echoing-post-hook.sh
 
 cat <<EOF > flake.nix
 {
-    nixConfig.post-build-hook = "$PWD/echoing-post-hook.sh";
+    nixConfig.post-build-hook = ./echoing-post-hook.sh;
 
     outputs = a: {
        defaultPackage.$system = import ./simple.nix;
@@ -32,3 +32,13 @@ clearStore
 
 nix build --accept-flake-config
 test -f post-hook-ran || fail "The post hook should have ran"
+
+# Make sure that the path to the post hook doesnâ€™t change if we change
+# something in the flake.
+# Otherwise the user would have to re-validate the setting each time.
+mv post-hook-ran previous-post-hook-run
+echo "# Dummy comment" >> flake.nix
+clearStore
+nix build --accept-flake-config
+diff -q post-hook-ran previous-post-hook-run || \
+    fail "Both post hook runs should report the same filename"
